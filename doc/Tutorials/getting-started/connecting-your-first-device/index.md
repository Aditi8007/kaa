---
layout: page
title: Connecting your first device
permalink: /:path/
sort_idx: 2
---

{% include variables.md %}
{% include_relative links.md %}

* TOC
{:toc}

<div align="center">
  <iframe width="640" height="385" src="https://www.youtube.com/embed/XjpJLzCM-KU?rel=0" frameborder="0"
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

## Overview

You will learn how to create a digital twin of your device, connect it and submit its metadata attributes in the JSON format to the platform, and view that data in the Kaa web interface.
Also, we will give here the definitions of such terms as "endpoint", "endpoint ID", "endpoint token" and "endpoint metadata", which explain some key entities in the Kaa platform.


## Terms definition

Let’s start with the definition of the basic terms.


### What is an endpoint?

**An endpoint represents a physical or virtual device that you've connected to the Kaa platform.** 
Therefore, an endpoint can either be an actual physical device or some software emulation of a device.
All data coming to the platform is closely associated with endpoints.


### What is an endpoint ID?

**Endpoint ID is used to uniquely identify an endpoint within the Kaa platform.**
An endpoint ID is usually a UUID that is automatically generated by the Kaa at the moment of creating a new endpoint.

All endpoint data, such as metadata attributes, collected time series data points, commands, etc., is associated with a specific endpoint ID.
Whenever you retrieve or manage endpoint-related data in Kaa (mainly via REST API or NATS), you will see endpoint IDs.


### What is an endpoint token?

**Endpoint tokens are used for endpoint identification during the endpoint communication with the Kaa platform.** 
An endpoint token is unique in the scope of a single [Kaa application][application] and assigned to exactly one endpoint. 

Each message sent by a device to the platform must include an endpoint token so that the platform could identify the endpoint that corresponds to the device.  

When some message from the device arrives at the Kaa platform, the device-related endpoint token is resolved into the corresponding endpoint ID.

In the case of the Kaa Protocol over MQTT, the endpoint token goes inside the MQTT topic (e.g. `kp1/<appversion_name>/epmx/<endpoint_token>/get`).

Typically, tokens are pseudo-random strings automatically generated by Kaa (e.g. `JTjdbENzHh`), but for convenience, you can also provision your own endpoint tokens (e.g. device serial number, MAC address, etc.).

**Decoupling of endpoint tokens from endpoint IDs allows you to suspend, revoke, reactivate, and re-issue endpoint tokens without impacting the endpoint ID.** 
To communicate with the Kaa platform, your devices or gateways do not need to know endpoint IDs but only endpoint tokens.


### What is an endpoint metadata?

**An endpoint metadata is a set of key-value attributes associated with an endpoint.** 
It can be any endpoint-related information, such as location, description, serial number, hardware version, etc. 
Metadata is stored in [Endpoint Registered service][EPR] and can be read or updated in two ways: either via the [communication layer][communication] or [EPR REST API][EPR REST API].

Speaking of the endpoint metadata format, endpoint metadata is a JSON document of an arbitrary format that is associated with a specific endpoint.


### What are application and application versions?

The Kaa platform is designed to handle different types of devices simultaneously and allow them to co-exist in the scope of a single solution. 
To do that, we use the concept of **Kaa application**.

Think of Kaa application as of container where you put your system configuration that depends on the device type.

For example, you want to manage a smart house containing fridges and coffee machines. In this case, you can set up two different applications: one for your fridges and the other one for your coffee machines. This means that all your fridges will be represented as a set of endpoints in one application while all the coffee machines will live in the other application.

Applications can have **versions**. Use versions to evolve your devices by adding or retiring features while keeping your old versions up and running.

Kaa supports running multiple versions simultaneously. 
This means that you can develop new functionality for your endpoints without disturbing your existing ones.


## Playbook

Let's create a new endpoint and retrieve/report its metadata attributes from/to the Kaa platform.

**1**. Go to the ["Devices" dashboard][devices dashboard], add a device with the optional metadata attribute `description`.

![Add an endpoint](attach/img/add-endpoint-with-metadata.png)

Remember the endpoint token.

![Remember the endpoint token](attach/img/remember-endpoint-token.png)

**2**. Use one of the bellow clients to retrieve and report metadata from/to the platform.

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#http-client">HTTP client</a></li>
  <li><a data-toggle="tab" href="#mqtt-client">MQTT client</a></li>
</ul>

<div class="tab-content"><div id="http-client" class="tab-pane fade in active" markdown="1">

<br>

Retrieve all endpoint metadata from the platform.

Swap `<app-version-name>` with the application version from the endpoint's dashboard and `<endpoint-token>` with the endpoint token from the previous step.

```bash
curl --location --request POST 'https://connect.cloud.kaaiot.com:443/kp1/<app-version-name>/epmx/<endpoint-token>/get' \
--data-raw '{}'
```

Report endpoint metadata to the platform.

```bash
curl --location --request POST 'https://connect.cloud.kaaiot.com:443/kp1/<app-version-name>/epmx/<endpoint-token>/update/keys' \
--data-raw '{
    "model": "MySmartMeter A300",
    "mac": "00-14-22-01-23-45"
}'
```

<br>

</div><div id="mqtt-client" class="tab-pane fade" markdown="1">

<br>

You can open [the bellow client in the Repl.it][connecting your first device repl] if you don't want to run it on your host machine.

Initialize `ENDPOINT_TOKEN` and `APPLICATION_VERSION` variables with endpoint token and application version respectively.

```python
import json
import random
import string
import time

import paho.mqtt.client as mqtt

KPC_HOST = "mqtt.cloud.kaaiot.com"
KPC_PORT = 1883

ENDPOINT_TOKEN = ""       # Paste endpoint token
APPLICATION_VERSION = ""  # Paste application version

print(f'Using endpoint token {ENDPOINT_TOKEN}, server at {KPC_HOST}:{KPC_PORT}')

request_id = random.randint(0, 99)

# MQTT PUBLISH topic: "get metadata" request
get_metadata_publish_topic = f'kp1/{APPLICATION_VERSION}/epmx/{ENDPOINT_TOKEN}/get/{request_id}'
print(f'{get_metadata_publish_topic} - MQTT PUBLISH topic: "get metadata" request')

# MQTT SUBSCRIBE topic: "get metadata" response
get_metadata_subscribe_topic = f'{get_metadata_publish_topic}/status'
print(f'{get_metadata_subscribe_topic} - MQTT SUBSCRIBE topic: "get metadata" response')

# MQTT PUBLISH topic: "partial metadata update" request
partial_metadata_udpate_publish_topic = f'kp1/{APPLICATION_VERSION}/epmx/{ENDPOINT_TOKEN}/update/keys/{request_id}'
print(f'{partial_metadata_udpate_publish_topic} - MQTT PUBLISH topic: "partial metadata update"')

# MQTT SUBSCRIBE topic: "partial metadata update" response
partial_metadata_update_subscribe_topic = f'{partial_metadata_udpate_publish_topic}/status'
print(f'{partial_metadata_update_subscribe_topic} - MQTT SUBSCRIBE topic: "partial metadata update"')

# MQTT PUBLISH topic: "full metadata update"
full_metadata_udpate_publish_topic = f'kp1/{APPLICATION_VERSION}/epmx/{ENDPOINT_TOKEN}/update'
print(f'{full_metadata_udpate_publish_topic} - MQTT PUBLISH topic: "full metadata update"')


# Returns hard-coded metadata
def get_metadata():
  return json.dumps(
    {
      "model": "MySmartMeter A300",
      "mac": "00-14-22-01-23-45"
    }
  )

def log_metadata(client, userdata, message):
  print(f'Received metadata from server: {str(message.payload.decode("utf-8"))} on topic: {message.topic}')


def log_partial_metadata_update_response(client, userdata, message):
  print(f'Received partial metadata update response: {str(message.payload.decode("utf-8"))} on topic: {message.topic}')


def on_message(client, userdata, message):
  print(f'Message received: topic: {message.topic}\nbody: {str(message.payload.decode("utf-8"))}')


def on_connect(client, userdata, flags, rc):
  print("Requesting metadata from server")
  # Request metadata
  client.publish(topic=get_metadata_publish_topic, payload=json.dumps({}))

def main():
  # Initiate server connection
  client_id = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(6))
  client = mqtt.Client(client_id=client_id)
  client.on_message = on_message
  client.on_connect = on_connect
  client.connect(KPC_HOST, KPC_PORT, 60)
  client.loop_start()

  client.message_callback_add(get_metadata_subscribe_topic, log_metadata)
  client.message_callback_add(partial_metadata_update_subscribe_topic, log_partial_metadata_update_response)

  # Report metadata
  data = get_metadata()
  client.publish(topic=partial_metadata_udpate_publish_topic, payload=data)
  print(f'Reported metadata: {data}')
  time.sleep(5)
  client.disconnect()

if __name__ == '__main__':
  main()
```

<br>

</div></div>

In this guide, you learned how to create a digital twin of your device, connect it, retrieve existing metadata from the platform, and report new metadata keys. 


## Resources

All the tutorial resources are located on [GitHub][code url].

[code url]:           https://github.com/kaaproject/kaa/tree/rel_1.2.0/doc/Tutorials/getting-started/connecting-your-first-device/attach/code
[devices dashboard]:  https://cloud.kaaiot.com/devices/device-management
